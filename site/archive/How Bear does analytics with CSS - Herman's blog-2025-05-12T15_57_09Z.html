<!-- Saved from https://herman.bearblog.dev/how-bear-does-analytics-with-css/ at 2025-05-12T15:57:09Z using monolith v2.10.1 -->
<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="script-src 'none';"></meta>
  
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
  
  <title>How Bear does analytics with CSS | Herman's blog</title>
  <link rel="canonical" href="https://herman.bearblog.dev/how-bear-does-analytics-with-css/">
  
    

    <meta name="herman" content="look-for-the-bear-necessities">

    <!-- Primary Meta Tags -->
<meta name="title" content="How Bear does analytics with CSS">
<meta name="description" content="Bear Blog has a few design constraints for speed, efficiency, and stability. There are many great open-source, privacy-focussed analytics platforms out there...">

<!-- Open Graph / Facebook -->
<meta property="og:site_name" content="Herman's blog">
<meta property="og:title" content="How Bear does analytics with CSS">
<meta property="og:type" content="article">
<meta property="og:url" content="https://herman.bearblog.dev/how-bear-does-analytics-with-css/">
<meta property="og:description" content="Bear Blog has a few design constraints for speed, efficiency, and stability. There are many great open-source, privacy-focussed analytics platforms out there...">
<meta property="og:image" content="https://bear-images.sfo2.cdn.digitaloceanspaces.com/herman-1683556668-0.png">


<!-- Twitter -->
<meta property="twitter:card" content="summary">
<meta property="twitter:url" content="https://herman.bearblog.dev/how-bear-does-analytics-with-css/">
<meta property="twitter:title" content="How Bear does analytics with CSS">
<meta property="twitter:description" content="Bear Blog has a few design constraints for speed, efficiency, and stability. There are many great open-source, privacy-focussed analytics platforms out there...">
<meta property="twitter:image" content="https://bear-images.sfo2.cdn.digitaloceanspaces.com/herman-1683556668-0.png">



<!-- Microdata -->
<script type="application/ld+json"></script>

  
    

    
    <link rel="stylesheet" href="data:text/css;charset=&quot;utf-8&quot;;base64,LmhsbHtiYWNrZ3JvdW5kLWNvbG9yOiNmZmN9LmN7Y29sb3I6IzQwODA4MDtmb250LXN0eWxlOml0YWxpY30uZXJye2JvcmRlcjoxcHggc29saWQgcmVkfS5re2NvbG9yOmdyZWVuO2ZvbnQtd2VpZ2h0OjcwMH0ub3tjb2xvcjojNjY2fS5jaHtjb2xvcjojNDA4MDgwO2ZvbnQtc3R5bGU6aXRhbGljfS5jbXtjb2xvcjojNDA4MDgwO2ZvbnQtc3R5bGU6aXRhbGljfS5jcHtjb2xvcjojYmM3YTAwfS5jcGZ7Y29sb3I6IzQwODA4MDtmb250LXN0eWxlOml0YWxpY30uYzF7Y29sb3I6IzQwODA4MDtmb250LXN0eWxlOml0YWxpY30uY3N7Y29sb3I6IzQwODA4MDtmb250LXN0eWxlOml0YWxpY30uZ2R7Y29sb3I6I2EwMDAwMH0uZ2V7Zm9udC1zdHlsZTppdGFsaWN9Lmdye2NvbG9yOnJlZH0uZ2h7Y29sb3I6bmF2eTtmb250LXdlaWdodDo3MDB9Lmdpe2NvbG9yOiMwMGEwMDB9Lmdve2NvbG9yOiM4ODh9Lmdwe2NvbG9yOm5hdnk7Zm9udC13ZWlnaHQ6NzAwfS5nc3tmb250LXdlaWdodDo3MDB9Lmd1e2NvbG9yOnB1cnBsZTtmb250LXdlaWdodDo3MDB9Lmd0e2NvbG9yOiMwNGR9Lmtje2NvbG9yOmdyZWVuO2ZvbnQtd2VpZ2h0OjcwMH0ua2R7Y29sb3I6Z3JlZW47Zm9udC13ZWlnaHQ6NzAwfS5rbntjb2xvcjpncmVlbjtmb250LXdlaWdodDo3MDB9Lmtwe2NvbG9yOmdyZWVufS5rcntjb2xvcjpncmVlbjtmb250LXdlaWdodDo3MDB9Lmt0e2NvbG9yOiNiMDAwNDB9Lm17Y29sb3I6IzY2Nn0uc3tjb2xvcjojYmEyMTIxfS5uYXtjb2xvcjojN2Q5MDI5fS5uYntjb2xvcjpncmVlbn0ubmN7Y29sb3I6IzAwZjtmb250LXdlaWdodDo3MDB9Lm5ve2NvbG9yOiM4MDB9Lm5ke2NvbG9yOiNhMmZ9Lm5pe2NvbG9yOiM5OTk7Zm9udC13ZWlnaHQ6NzAwfS5uZXtjb2xvcjojZDI0MTNhO2ZvbnQtd2VpZ2h0OjcwMH0ubmZ7Y29sb3I6IzAwZn0ubmx7Y29sb3I6I2EwYTAwMH0ubm57Y29sb3I6IzAwZjtmb250LXdlaWdodDo3MDB9Lm50e2NvbG9yOmdyZWVuO2ZvbnQtd2VpZ2h0OjcwMH0ubnZ7Y29sb3I6IzE5MTc3Y30ub3d7Y29sb3I6I2EyZjtmb250LXdlaWdodDo3MDB9Lnd7Y29sb3I6I2JiYn0ubWJ7Y29sb3I6IzY2Nn0ubWZ7Y29sb3I6IzY2Nn0ubWh7Y29sb3I6IzY2Nn0ubWl7Y29sb3I6IzY2Nn0ubW97Y29sb3I6IzY2Nn0uc2F7Y29sb3I6I2JhMjEyMX0uc2J7Y29sb3I6I2JhMjEyMX0uc2N7Y29sb3I6I2JhMjEyMX0uZGx7Y29sb3I6I2JhMjEyMX0uc2R7Y29sb3I6I2JhMjEyMTtmb250LXN0eWxlOml0YWxpY30uczJ7Y29sb3I6I2JhMjEyMX0uc2V7Y29sb3I6I2I2Mjtmb250LXdlaWdodDo3MDB9LnNoe2NvbG9yOiNiYTIxMjF9LnNpe2NvbG9yOiNiNjg7Zm9udC13ZWlnaHQ6NzAwfS5zeHtjb2xvcjpncmVlbn0uc3J7Y29sb3I6I2I2OH0uczF7Y29sb3I6I2JhMjEyMX0uc3N7Y29sb3I6IzE5MTc3Y30uYnB7Y29sb3I6Z3JlZW59LmZte2NvbG9yOiMwMGZ9LnZje2NvbG9yOiMxOTE3N2N9LnZne2NvbG9yOiMxOTE3N2N9LnZpe2NvbG9yOiMxOTE3N2N9LnZte2NvbG9yOiMxOTE3N2N9Lmlse2NvbG9yOiM2NjZ9">
  
  
  
    
        <link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJz48dGV4dCB5PScuOWVtJyBmb250LXNpemU9JzkwJz7wn5CoPC90ZXh0Pjwvc3ZnPg==">
    



  <style>
      
      
    
:root {
    --width: 720px;
    --font-main: Verdana, sans-serif;
    --font-secondary: Verdana, sans-serif;
    --font-scale: 1em;
    --background-color: #fff;
    --heading-color: #222;
    --text-color: #444;
    --link-color: #3273dc;
    --visited-color:  #8b6fcb;
    --code-background-color: #f2f2f2;
    --code-color: #222;
    --blockquote-color: #222;
}

@media (prefers-color-scheme: dark) {
    :root {
        --background-color: #01242e;
        --heading-color: #eee;
        --text-color: #ddd;
        --link-color: #8cc2dd;
        --visited-color:  #8b6fcb;
        --code-background-color: #000;
        --code-color: #ddd;
        --blockquote-color: #ccc;
    }
}

body {
    font-family: var(--font-secondary);
    font-size: var(--font-scale);
    margin: auto;
    padding: 20px;
    max-width: var(--width);
    text-align: left;
    background-color: var(--background-color);
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: var(--text-color);
}

h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-main);
    color: var(--heading-color);
}

a {
    color: var(--link-color);
    cursor: pointer;
    text-decoration: none;
}

a:hover {
    text-decoration: underline; 
}

nav a {
    margin-right: 8px;
}

strong, b {
    color: var(--heading-color);
}

button {
    margin: 0;
    cursor: pointer;
}

time {
 	font-family: monospace;
  	font-style: normal;
  	font-size: 15px;
}

main {
    line-height: 1.6;
}

table {
    width: 100%;
}

hr {
    border: 0;
    border-top: 1px dashed;
}

img {
    max-width: 100%;
}

code {
    font-family: monospace;
    padding: 2px;
    background-color: var(--code-background-color);
    color: var(--code-color);
    border-radius: 3px;
}

blockquote {
    border-left: 1px solid #999;
    color: var(--code-color);
    padding-left: 20px;
    font-style: italic;
}

footer {
    padding: 25px 0;
    text-align: center;
}

.title:hover {
    text-decoration: none;
}

.title h1 {
    font-size: 1.5em;
}

.inline {
    width: auto !important;
}

.highlight, .code {
    padding: 1px 15px;
    background-color: var(--code-background-color);
    color: var(--code-color);
    border-radius: 3px;
    margin-block-start: 1em;
    margin-block-end: 1em;
    overflow-x: auto;
}

/* blog post list */
ul.blog-posts {
    list-style-type: none;
    padding: unset;
}

ul.blog-posts li {
    display: flex;
}

ul.blog-posts li span {
    flex: 0 0 130px;
}

ul.blog-posts li a:visited {
    color: var(--visited-color);
}
    .upvote-button {
        padding: 0;
        margin: 0;
        border: 0;
        background-color: inherit;
        color: inherit;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .upvote-button.upvoted {
        color: salmon;
    }
    .upvote-count {
        margin-top: -3px;
    }

      
  </style>

  
    
    <style>
        body:hover {
            shape-outside: url("data:text/html;charset=utf-8;base64,TG9nZ2Vk");
        }
    </style>
    

<meta name="robots" content="none"></meta></head>

<body class="post ">
  
  <header>
    <a class="title" href="https://herman.bearblog.dev/">
      <h1>
        Herman's blog
      </h1>
    </a>
    <nav>
      <p><a href="https://herman.bearblog.dev/">Home</a> <a href="https://herman.bearblog.dev/now/">Now</a> <a href="https://herman.bearblog.dev/projects/">Projects</a> <a href="https://herman.bearblog.dev/blog/">Blog</a></p>

    </nav>
  </header>
  <main>
    

    
        
    

    
        <h1>How Bear does analytics with CSS</h1>

        <p>
            <i>
                <time datetime="2023-11-01T07:36Z">
                    01 Nov, 2023
                </time>
            </i>
        </p>
    

    <p>Bear Blog has a few design constraints for speed, efficiency, and stability. There are many great open-source, privacy-focussed analytics platforms out there, but I wanted to build one native to Bear.</p>
<p><a href="#tldr">tldr;</a></p>
<p>One of my constraints for Bear is to not use client-side javascript. This applies to the analytics system as well. Client-side javascript can be tweaked to determine the authenticity of traffic to a page and determine (partially) whether it is bot traffic or not, which is very useful for analytics. The main downside, however, is that most adblockers block analytics scripts. And not just the bad ones, like Google Analytics. Even Fathom and Plausible analytics struggle with logging activity on adblocked browsers.</p>
<p>There's always the option of just parsing server logs, which gives a rough indication of the kinds of traffic accessing the server. Unfortunately all server traffic is generally seen as equal. Technically bots "should" have a user-agent that identifies them as a bot, but few identify that since they're trying to scrape information as a "person" using a browser. In essence, just using server logs for analytics gives a skewed perspective to traffic since a lot of it are search-engine crawlers and scrapers (and now GPT-based parsers).</p>
<p>So instead of using server logs, I trigger a read with CSS. Here's my slightly boutique analytics system.</p>
<p>When a person accesses the website the page is loaded.
On each page I have the following CSS:</p>
<div class="highlight"><pre><span></span>body:hover {
    border-image: url("/hit/{{ post.id }}/?ref={{ request.META.HTTP_REFERER }}");
}
</pre></div>
<p>The only info I need to actively re-add to this request is the referrer (yes, HTTP_REFERER is <a href="https://en.wikipedia.org/wiki/HTTP_referer" target="_blank">spelt incorrectly</a>).</p>
<p>Now, when a person hovers their cursor over the page (or scrolls  on mobile) it triggers <code>body:hover</code> which calls the URL for the post hit. I don't think any bots hover and instead just use JS to interact with the page, so I can, with reasonable certainty, assume that this is a human reader.</p>
<p>I then confirm the user-agent isn't a bot (which isn't perfect, but still something). I also extract the browser and platform from the user-agent string.</p>
<p>My second constraint is to not store any identifying information about the reader either in browser cookies, or on the server. In order to do this I use the IP address of the request to determine the country, then hash the IP address along with the date. All subsequent requests to the page are checked for matching IP address + date hashes and duplicates are discarded.</p>
<p>In this way each IP address per day constitutes one "read" of the page. No IP addresses are stored un-hashed and the IP-with-date-hash creates a convenient built-in expiry time.</p>
<p>Here's the code if you're interested:</p>
<div class="highlight"><pre><span></span><span class="n">user_agent</span> <span class="o">=</span> <span class="n">httpagentparser</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'HTTP_USER_AGENT'</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">if</span> <span class="n">user_agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'bot'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Bot traffic'</span><span class="p">)</span>
    <span class="k">return</span>

<span class="n">ip_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">client_ip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="n">country</span> <span class="o">=</span> <span class="n">get_user_location</span><span class="p">(</span><span class="n">client_ip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'country_name'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">user_agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'platform'</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
<span class="n">browser</span> <span class="o">=</span> <span class="n">user_agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'browser'</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>

<span class="n">referrer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ref'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
<span class="k">if</span> <span class="n">referrer</span><span class="p">:</span>
    <span class="n">referrer</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">referrer</span><span class="p">)</span>
    <span class="n">referrer</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{uri.scheme}</span><span class="s1">://</span><span class="si">{uri.netloc}</span><span class="s1">/'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">referrer</span><span class="p">)</span>

<span class="n">Hit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
    <span class="n">post_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
    <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_hash</span><span class="p">,</span>
    <span class="n">referrer</span><span class="o">=</span><span class="n">referrer</span><span class="p">,</span>
    <span class="n">country</span><span class="o">=</span><span class="n">country</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
    <span class="n">browser</span><span class="o">=</span><span class="n">browser</span><span class="p">)</span>
</pre></div>
<p><small>edit:</small> The IP address hash's only use is to prevent duplicate hits for a given day. This way all page views are unique by default. I then have a background task which runs at the end of each day to scrub the hashes from the hit logs, so as to not step on any over-zealous GDPR advocate's toes.</p>
<p>The only downside to this method is if there are multiple reads from the same IP address but on separate devices, it will still only be seen as one read. And I'm okay with that since it constitutes such a minor fragment of traffic. This provides an accurate count of reads and I feel is more concise and simpler than many other forms of analytics capture.</p>
<h2 id="tldr">tldr;</h2><p>I use CSS to trigger a url analytics endpoint on <code>body:hover</code>, determine useful information from the IP address and user-agent, then hash the IP address with the date to create a unique "read" of a page.</p>
<h5 id="enjoyed-the-article-i-write-about-1-2-a-month-subscribe-via-a-hrefsubscribeemaila-or-a-hreffeedrss-feeda">Enjoyed the article? I write about 1-2 a month. Subscribe via <a href="https://herman.bearblog.dev/subscribe/">email</a> or <a href="https://herman.bearblog.dev/feed/">RSS feed</a>.</h5>

    

    
        
            <p class="tags">
                
                    <a href="https://herman.bearblog.dev/archive/?q=bearblog">#bearblog</a>
                
            </p>
        

        
            <form id="upvote-form" action="https://herman.bearblog.dev/upvote/ijrWiYRdHUCBKptDKYDA/" method="post" style="display: inline">
    <small>
        <input hidden="" name="uid" value="ijrWiYRdHUCBKptDKYDA" style="display:none">
        <input hidden="" name="title" style="display:none">
        <input type="hidden" name="csrfmiddlewaretoken" value="MGhNqw2BYaowIOyhht78rsb2BRHWGqCITLNG4z2wH0MJyOHNvgrg4QtdFfUocNqG">
        
        <button class="upvote-button" title="Toast this post">
        
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <polyline points="17 11 12 6 7 11"></polyline>
                <polyline points="17 18 12 13 7 18"></polyline>
            </svg>
            <small class="upvote-count">1078</small>
        </button>
    </small>        
</form>

<script></script>
        
    


  </main>
  <footer style="padding:25px 0;">
    
    
        <span id="footer-directive">
            <p><small>Subscribe via <a href="https://herman.bearblog.dev/feed/">rss</a>, <a href="https://herman.bearblog.dev/subscribe/">email</a> or just say <a href="https://herman.bearblog.dev/contact/">hello</a>.</small></p>
<script data-site="BXLKPFV" defer=""></script>
<script></script>

        </span>
    
    <span>
        Powered by <a href="https://bearblog.dev">Bear ʕ•ᴥ•ʔ</a>
    </span>

  </footer>

</body></html>
